<template name="manageDataSets">
  <h1>Data sets</h1>

  <p>
    A data set is a collection of samples' genomic information.
  </p>

  <div class="ui grid">
    <div class="four wide column">
      <div class="ui vertical fluid tabular menu">
        <a href={{pathFor "createDataSet"}}
            class="item {{#if (isActiveRoute "createDataSet")}}
                active{{/if}}">
          Create new
          <i class="plus icon"></i>
        </a>

        {{#each getDataSets}}
          <a href={{pathFor "manageDataSets"
                  query=(concat "data_set_id=" _id)}}
              class="{{#if compare (queryParam "data_set_id") _id}}
                  active{{/if}} item">
            {{name}}
          </a>
        {{/each}}
      </div>
    </div>
    <div class="twelve wide stretched column">
      {{! some things look funky if we remove this wrapper div}}
      <div>
        {{#if isActiveRoute "manageDataSets"}}
          {{#if getDataSet}}
            {{> showDataSet getDataSet}}
          {{else}}
            {{#if Template.subscriptionsReady}}
              <!-- {{#if queryParam "data_set_id"}}
                <div class="ui error message">
                  <div class="header">
                    Invalid data set id in the URL
                  </div>
                  <p>
                    The data set either doesn't exist or you don't
                    have access to it. You likely got this URL from
                    someone who has access to the data set, in which
                    case you should ask them to share the data set with you.
                  </p>
                  <p>
                    If you believe you are seeing this message in error,
                    please {{> contactTeoButton}}
                  </p>
                </div>
              {{else}} -->
                {{#if length getDataSets}}
                  <h3>
                    Nothing selected
                  </h3>
                  <p>
                    Select a data set on the left panel to
                    view more information about it.
                  </p>
                {{else}}
                  <h3>
                    You do not have access to any data sets... yet!
                  </h3>
                  <p>
                    <a href={{pathFor "createDataSet"}}>
                      Click here to create a new data set.
                    </a>
                  </p>
                {{/if}}
              <!-- {{/if}} -->
            {{else}}
              {{> dataLoading}}
            {{/if}}
          {{/if}}
        {{else}}
          {{> createDataSet}}
        {{/if}}
      </div>
    </div>
  </div>
</template>

<template name="createDataSet">
  <h3>Create new data set</h3>

  {{#autoForm id="insertDataSet" schema=nameAndDescription
      type="method" meteormethod="insertDataSet"}}
    {{> afQuickField name="name" type="text"
        placeholder="What do you want to call your data set?"}}
    <p>
      Note: you cannot change the name of data sets after
      they are created.
    </p>

    {{> afQuickField name="description" type="textarea" rows="3"
        placeholder="What data is going to be stored in this data set?"}}

    <button type="submit" class="ui primary button">Create!</button>
  {{/autoForm}}
</template>

<template name="showDataSet">
  <h3>
    {{name}}

    {{#if Template.subscriptionsReady}}
      {{> shareAndDeleteButtons object=this collectionName="DataSets"
          extraButtonsClass="right floated"}}
    {{/if}}
  </h3>

  {{#if Template.subscriptionsReady}}
    <p>
      {{description}}
    </p>

    <h4>Information</h4>
    <div class="ui list">
      <div class="item">
        Gene expression gene count:
        {{#if gene_expression_genes}}
          {{length gene_expression_genes}}
        {{else}}
          No data loaded
        {{/if}}
      </div>
    </div>

    <h4>Samples</h4>
    {{#if length sample_labels}}
      {{#if firstGreater 500 (length sample_labels)}}
        <table class="ui celled structured table">
          <thead>
            <tr>
              <th>Sample</th>
              <th>Gene expression</th>
            </tr>
          </thead>
          <tbody>
            {{#each sample_labels}}
              <tr>
                <td><i class="fa fa-flask"></i>{{this}}</td>
                <td class="center aligned">
                  <i class="large icon
                      {{dataExistsClasses "gene_expression_index"}}"></i>
                </td>
              </tr>
            {{/each}}
          </tbody>
        </table>
      {{else}}
        <div class="ui message">
          <div class="header">
            Too many samples
          </div>
          <p>
            For data sets containing more than 500 samples, this table
            cannot be shown.
          </p>
          <p>
            To create a feature request: {{> contactTeoButton}}
          </p>
        </div>
      {{/if}}
    {{else}}
      <div class="ui message">
        <div class="header">
          No samples
        </div>
        <p>
          Add samples using the form below.
        </p>
      </div>
    {{/if}}

    <h4>Add a sample</h4>
    {{#autoForm id="newSampleLabel" schema=newSampleSchema
        type="method" meteormethod="newSampleLabel"}}
      {{> afQuickField name="sample_label" type="text"
          placeholder="Name of sample"}}

      {{> afQuickField name="data_set_id" type="hidden" value=../_id}}
      <button type="submit" class="ui primary button">Add sample</button>
    {{/autoForm}}
  {{else}}
    {{> dataLoading}}
  {{/if}}
</template>
