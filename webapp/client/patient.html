<template name="patient">
  {{#if Template.subscriptionsReady}}
    {{#with getPatient}}
      <h1 class="title ui">
        <i class="fa fa-user"></i>
        {{patient_label}}
      </h1>

      {{> questions}}
    {{/with}}

    {{#unless getPatient}}
      <div class="ui icon message massive">
        <i class="warning sign icon"></i>
        <div class="content">
          <div class="header">
            Uh oh...
          </div>
          <p>We couldn't find the patient with that ID</p>
        </div>
      </div>
    {{/unless}}
  {{else}}
    {{> dataLoading}}
  {{/if}}
</template>



<template name="questions">
  <!-- <div class="ui fluid styled accordion"> -->
    {{#if length sample_labels}}
      <h2 class="title ui">
        <!-- <i class="dropdown icon"></i> -->
        Which data have been loaded?
      </h2>
      <div class="content">
        {{> patientLoadedData}}
      </div>


      <h2 class="title ui">
        <!-- <i class="dropdown icon"></i> -->
        Which cancers is this cancer most like?
      </h2>
      <div class="content">
        {{> patientTumorMap}}
      </div>


      <h2 class="title ui">
        <!-- <i class="dropdown icon"></i> -->
        What are the most up/down-regulated genes?
      </h2>
      <div class="content">
        {{> patientUpDownGenes}}
      </div>
    {{else}}
      {{! error message if there are no samples}}
      <div class="ui warning message">
        This patient has no samples associated with it.
        Questions that provide sample-level information have been hidden.
      </div>
    {{/if}}


    <!-- <h2 class="title ui">
      <i class="dropdown icon"></i>
      Are there clinically actionable mutations in any samples?
    </h2>
    <div class="content">
      <p>No</p>
    </div> -->
  <!-- </div> -->
</template>



<template name="patientLoadedData">
  <h3>Gene expression</h3>
  <table class="ui celled structured table">
    <thead>
      <tr>
        <th>Sample</th>
        <th>Quantile counts log2(x+1)</th>
        <!-- <th>FPKM</th>
        <th>TPM</th> -->
      </tr>
    </thead>
    <tbody>
      {{#each sample_labels}}
        <tr>
          <td><i class="fa fa-flask"></i>{{this}}</td>
          <td class="center aligned">
            <i class="large icon {{geneExpExists "rsem_quan_log2"}}"></i>
          </td>
          <!-- <td class="center aligned">
            <i class="large icon {{geneExpExists "tpm"}}"></i>
          </td>
          <td class="center aligned">
            <i class="large icon {{geneExpExists "fpkm"}}"></i>
          </td> -->
        </tr>
      {{/each}}
    </tbody>
  </table>
</template>

<template name="patientTumorMap">
  <p>
    <a href="https://tumormap.ucsc.edu/">TumorMap</a>
    clusters samples based on expression values or other genomic
    data such as mutations.
  </p>

  <table class="ui structured celled table">
    <thead>
      <tr>
        <th rowspan="2">Sample</th>
        <th colspan="3">Cluster by...</th>
      </tr>
      <tr>
        {{#each mapTypes}}
          <th>{{title}}</th>
        {{/each}}
      </tr>
    </thead>
    <tbody>
      {{#each sample_labels}}
        <tr>
          <td><i class="fa fa-flask"></i>{{this}}</td>
          {{! #let here so that we can get to it inside the #each}}
          {{#let sample_label=this}}
            {{#each mapTypes}}
              <td>
                {{#if compare mapLabel "gene_expression"}} {{! XXX}}
                  {{> tumorMapButton mapLabel=this.mapLabel
                      sample_label=sample_label}}
                {{else}}
                  No data
                {{/if}}
              </td>
            {{/each}}
          {{/let}}
        </tr>
      {{/each}}
    </tbody>
  </table>
</template>

<template name="tumorMapButton">
  {{#if bookmarkExists}}
    <a href={{getBookmark}} target="_blank" class="ui primary button tiny">
      View
    </a>
  {{else}}
    <div class="ui secondary button tiny
        {{#if creatingBookmark}}loading{{else}}generate-bookmark{{/if}}">
      Generate
    </div>
  {{/if}}
</template>



<template name="patientUpDownGenes">
  <form id="create-up-down-genes" class="ui form">
    <div style="font-size: 16px;">
      Calculate misregulated genes in
      <!-- <button class="ui tiny labeled icon dropdown button" type="button">
        <i class="flask icon"></i> -->
      <button class="ui tiny dropdown button" type="button">
        <span class="text">Sample</span>
        <div class="menu">
          {{#each sample_labels}}
            <div class="item choose-sample-label">{{this}}</div>
          {{/each}}
        </div>
      </button>
      compared to
      <button class="ui tiny dropdown button field" type="button">
        <span class="text">
          Background
        </span>

        <div class="menu">
          <div class="item choose-custom-sample-group">
            <i class="plus icon"></i>
            Create new
          </div>

          {{#each getSampleGroups}}
            <div class="item choose-sample-group">
              {{name}}
            </div>
          {{/each}}
        </div>
      </button>.

      {{#unless getInstanceReactive "customSampleGroup"}}
        <button class="ui tiny primary labeled icon button
              {{#if getInstanceReactive "waitingForResponse"}}loading{{/if}}"
            id="create-up-down-genes" type="submit">
          <i class="arrow right icon"></i> Go!
        </button>
      {{/unless}}
    </div>
  </form>

  {{#if getInstanceReactive "customSampleGroup"}}
    <div class="ui warning message">
      <div class="header">
        Not ready yet!
      </div>
      Creating sample groups on the fly isn't ready just yet.
    </div>
  {{/if}}

  {{#with getInstanceReactive "error"}}
    <div class="ui error message">
      <i class="close icon close-error-message"></i>
      <div class="header">{{header}}</div>
      {{{message}}}
    </div>
  {{/with}}

  {{> patientUpDownGenesTable}}
</template>

<template name="patientUpDownGenesTable">
  {{#if Template.subscriptionsReady}}
    {{#if length getJobs}}
      <table class="ui single line table">
        <thead>
          <tr>
            <th>Sample</th>
            <th>Comparison sample group</th>
            <th>Upregulated genes</th>
            <th>Downregulated genes</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {{#each getJobs}}
            <tr>
              <td><i class="fa fa-flask"></i>{{this.args.sample_label}}</td>
              <td>{{this.args.sample_group_name}}</td>
              <td>{{this.output.up_genes.length}}</td>
              <td>{{this.output.down_genes.length}}</td>
              <td>
                <a href={{pathFor "upDownGenes" study_label=(param "study_label")
                        patient_label=(param "patient_label") job_id=this._id}}
                    class="ui right labeled icon button">
                  <i class="right arrow icon"></i>
                  View
                </a>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    {{else}}
      <div class="ui message">
        <div class="content">
          <div class="header">
            No analyses
          </div>
          <p>
            No analyses have been run for this patient.
            Use the form above to run a new analysis.
          </p>
        </div>
      </div>
    {{/if}}
  {{else}}
    {{> dataLoading}}
  {{/if}}
</template>
